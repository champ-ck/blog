<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>ลองเขียน nodejs + rxjs · I&#x27;m Champ</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;ในโปรเจคนี้เป็นการลองเขียน nodejs + rxjs ซึ่งเป็นโปรเจคที่ผมลองสร้างขึ้นเพื่อทดสอบเฉยๆนะครับ โดยสิ่งที่ได้ทำการทดลองก็คือ&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="ลองเขียน nodejs + rxjs · I&#x27;m Champ"/><meta property="og:type" content="website"/><meta property="og:url" content="https://champunderscore.github.io/blog/index.html"/><meta property="og:description" content="&lt;p&gt;ในโปรเจคนี้เป็นการลองเขียน nodejs + rxjs ซึ่งเป็นโปรเจคที่ผมลองสร้างขึ้นเพื่อทดสอบเฉยๆนะครับ โดยสิ่งที่ได้ทำการทดลองก็คือ&lt;/p&gt;
"/><meta property="og:image" content="https://champunderscore.github.io/blog/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://champunderscore.github.io/blog/img/docusaurus.png"/><link rel="shortcut icon" href="/blog/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/blog/css/main.css"/></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/blog/"><img class="logo" src="/blog/img/favicon.png" alt="I&#x27;m Champ"/><h2 class="headerTitleWithLogo">I&#x27;m Champ</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/blog/docs/AndroidLayoutExample1" target="_self">Android</a></li><li class=""><a href="/blog/docs/doc2" target="_self">React</a></li><li class="siteNavGroupActive siteNavItemActive"><a href="/blog/docs/NodeJsWithRxJs" target="_self">NodeJS</a></li><li class=""><a href="/blog/docs/doc4" target="_self">DevOps</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>NodeJs</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">NodeJs</h3><ul><li class="navListItem navListItemActive"><a class="navItem" href="/blog/docs/NodeJsWithRxJs">ลองเขียน nodejs + rxjs</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">ลองเขียน nodejs + rxjs</h1></header><article><div><span><p>ในโปรเจคนี้เป็นการลองเขียน nodejs + rxjs ซึ่งเป็นโปรเจคที่ผมลองสร้างขึ้นเพื่อทดสอบเฉยๆนะครับ โดยสิ่งที่ได้ทำการทดลองก็คือ</p>
<ul>
<li>ลองใช้ Class ใน js ดู</li>
<li>ลองตั้งซื่อตัวแปรและ method ให้คล้ายๆ java</li>
<li>ลองใช้ rxjs</li>
<li>ลองเขียนแบบ functional</li>
</ul>
<p>บทความหรือ docs ที่แนะนำ</p>
<ul>
<li><a href="https://rxjs-dev.firebaseapp.com/guide/overview">Rxjs Documentation</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes">Class</a></li>
<li><a href="https://www.sitepoint.com/rxjs-functions-with-examples/">10 Need-to-Know RxJS Functions with Examples</a></li>
</ul>
<blockquote>
<p>ต้องบอกก่อนเลยว่าการเขียนแบบ oop ใน js ไม่ค่อย work เท่าไหร่ ส่วนตัวพอไปลองเขียน typescript กับรู้สึกชอบมากกว่า ถ้าเป็นสาย static type แนะนำ typescript เลยจ้า</p>
</blockquote>
<p>clone this project <a href="https://github.com/champunderscore/node-rxjs-example">GitHub</a></p>
<h2><a class="anchor" aria-hidden="true" id="getting-started"></a><a href="#getting-started" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting Started</h2>
<p>หลังจาก clone มาแล้ว ก็ต้อง start mongo ขึ้นมาซะก่อน สำหรับใครที่ไม่มี mongo ก็แนะนำให้ลง docker ซะ และก็ start mongo ด้วยคำสั่ง</p>
<pre><code class="hljs css language-bash">docker run -d -p 27017:27017 --name mongo mongo
</code></pre>
<p>start project</p>
<pre><code class="hljs"><span class="hljs-built_in">npm</span> install -g nodemon
<span class="hljs-built_in">npm</span> i
<span class="hljs-built_in">npm</span> start
</code></pre>
<p>มีอะไรให้เล่นบ้าง ก่อนอื่นมาลองดูโครงสร้างโปรเจคคร่าวๆกันก่อน</p>
<pre><code class="hljs">├── app
|  ├──<span class="hljs-built_in"> config
</span>|  ├── domain
|  ├──<span class="hljs-built_in"> server
</span>| <span class="hljs-built_in">..</span><span class="hljs-built_in">..</span><span class="hljs-built_in">..</span>
</code></pre>
<p>แน่นอนครับชั้นนอกสุดก็เป็นพวก project config ต่างๆ eslint, docker, package.json บลาๆ...</p>
<p>ส่วนใน app ก็เป็นทุกอย่างที่เกี่ยวกับ app ของเรา</p>
<ul>
<li>config เก็บ config หรือ env variable ต่างๆ</li>
<li>domain อันนี้จะเก็บโค้ดต่างๆ</li>
<li>server เก็บโค้ดเกี่ยวกับ server หรือ middleware บลาๆ</li>
</ul>
<p>ลองดูใน <code>app/server/app.js</code> ก็จะเห็นส่วนที่เป็น middleware ของเราทั้งหมด</p>
<p>endpoint ต่างๆจะถูกเก็บไว้ที่ <code>app/server/routes.js</code> เราลองมาดูว่ามีไรบ้าง</p>
<pre><code class="hljs css language-js"><span class="hljs-comment">/* test endpoint */</span>
router.get(<span class="hljs-string">'/test'</span>, (req, res) =&gt; {
  <span class="hljs-built_in">console</span>.log(req)
  res.json({ <span class="hljs-attr">test</span>: <span class="hljs-string">'test'</span> })
})

<span class="hljs-comment">/* get user by id */</span>
router.get(<span class="hljs-string">'/user'</span>, (req, res) =&gt; userController.mGetUser(req, res))
<span class="hljs-comment">/* create user by email */</span>
router.post(<span class="hljs-string">'/user'</span>, (req, res) =&gt; userController.mCreate(req, res))
<span class="hljs-comment">/* list users */</span>
router.get(<span class="hljs-string">'/users'</span>, (req, res) =&gt; userController.mListUser(req, res))
</code></pre>
<p>ผมจะลองยิงสร้าง user ด้วย postman ดู</p>
<p><img src="./assets/NodeJsWithRxJs/img1.png" alt="Image1"></p>
<p>ผลลัพธ์ที่ได้ก็ประมาณนี้ ถ้าเราลองไปเรียก get หรือ list ดูก็จะได้ค่าที่เราเพิ่งเพิ่มไป</p>
<h2><a class="anchor" aria-hidden="true" id="how-it-work"></a><a href="#how-it-work" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How it work</h2>
<p>โค้ดทั้งหมดของเราจะถูกเก็บไว้ที่ domain แต่ว่าทำไมละ?</p>
<p>ลองนึกภาพว่าเราสร้าง api เกี่ยวกับ user ซักพักเราต้องสร้าง api เกี่ยวกับ admin และก็มี report ตามมา การแยก domain ทำให้เรารู้ว่าข้างในเก็บโค้ดของส่วนไหนอยู่ และยังง่ายต่อการกลับมาแก้ไขอีกด้วย แต่สิ่งหนึ่งที่แชร์กันได้ก็คือ repositories หรือ database นั่นละ เพราะบางที domain admin ก็มีโอกาศมาดึงข้อมูลของ user เหมือนกัน เพราะฉะนั้นเราจะเอา repositories ไว้ชั้นเดียวกับแต่ละ domain หน้าตาก็ประมาณนี้</p>
<pre><code class="hljs">├── domain
|  ├── repositories
|  ├──<span class="hljs-built_in"> user
</span>|  ├── admin
|  ├── report
</code></pre>
<p>อันนี้ในกรณีที่เราออกแบบให้เป็น Monolithic นะครับ แต่ถ้าเป็น Microservices ก็ยังมี Achitecture หลายๆแบบ ที่ตอบโจทย์
ส่วนในโปรเจคนี้ผมเขียนเองจากความเจ็บปวดล้วนๆ 555</p>
<p>ในแต่ละ domain ก็จะมีหน้าตาประมาณนี้</p>
<pre><code class="hljs">├──<span class="hljs-built_in"> user
</span>|  ├── controllers
|  ├── functionals
|  ├── models
|  ├── schemas
|  ├── business
</code></pre>
<blockquote>
<p>Controllers : ถ้าเราลองไปดูที่ routes.js ของเราก็จะเห็นว่ามันชี้มาที่ controller
โดยหน้าที่ของมันก็คือการรับ input ต่างๆที่ส่งมากับ request และทำการ validate
และส่งไปที่ชั้น business logic หลังจากนั้นก็ทำการ respone ข้อมูลกลับไป</p>
</blockquote>
<blockquote>
<p>Business : อะไรก็ตามที่เป็น business logic เช่นดึงข้อมูลจาก repo และเอามาเพิ่ม point ให้ user แต่ละคน อื่นๆ... ก็จะถูกเก็บไว้ตรงนี้</p>
</blockquote>
<blockquote>
<p>Functionals : อันนี้ตั้งซื่อชัดเจนมาก โค้ดส่วนไหนก็ตามที่แยกเป็น function ได้ ก็แยกเถอะนะ
อาจจะแยกไว้เป็นไฟล์หรือรวมเป็นไฟล์เดียวกันและตั้งซื่อให้ชัดเจนว่าใช้ใน controller หรือ business เท่านั้นก็ได้</p>
</blockquote>
<blockquote>
<p>Models : เวลาที่จะปั้นข้อมูลไปเก็บใน db ก็ใช้ model ช่วยสิ</p>
</blockquote>
<blockquote>
<p>Schemas : อันนี้เวลา controller จะ respone อะไร ก็มาปั้นหน้าตาในนี้ก่อนจะออกไป</p>
</blockquote>
<p>Note : สามารถแยกไฟล์ controller หรือ business เป็นไฟล์ย่อยๆ ตาม api ก็ได้นะ เช่น list user ผมเห็นว่าโค้ดมันยาวก็แยกออกมาจากไฟล๋ UserController, UserBusiness ให้เป็นไฟล์สำหรับ api list user ไปเลย</p>
<h2><a class="anchor" aria-hidden="true" id="rxjs"></a><a href="#rxjs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RxJs</h2>
<p>ข่วงแนะนำบทความ สำหรับใครที่ไม่เคยใช้ rx มาก่อน แนะนำให้อ่านบทความด้านล่างซักนิดนึงนะครับ</p>
<ul>
<li><a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">The introduction to Reactive Programming you've been missing</a></li>
<li><a href="http://reactivex.io/documentation/observable.html">Observable</a></li>
</ul>
<p><code>In ReactiveX an observer subscribes to an Observable. Then that observer reacts to whatever item or sequence of items the Observable emits.</code></p>
<p>ถ้าลองเปิดใน <code>UserController.js</code> ก็จะเห็นว่าตัว controller ทำหน้าที่เป็น observer และ business และ repo ก็เป็น Observable
หลักการก็คือเวลา query หรือ insert ข้อมูล repo จะ return Observable ไปให้ business จากนั้น business จะเอาข้อมูลไปใช้งานต่อ เช่น</p>
<pre><code class="hljs css language-js">mListUser() {
  <span class="hljs-keyword">const</span> observable = <span class="hljs-keyword">this</span>.userRepository.mListAllUser().pipe(
    map(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> addUserPoint(data)
    })
  )

  <span class="hljs-keyword">return</span> observable
}
</code></pre>
<blockquote>
<p>ในตัวอย่างนี้ผมเอา user แต่ละคนไป add point เพิ่ม</p>
</blockquote>
<p>และจากนั้น controller ก็จะ subscribes เอาไว้และพอได้ข้อมูลก็จะ response ออกไป</p>
<p>ในด้านความสะดวกสบาย rxjs ก็มี function หลายๆอย่างให้เราใช้งาน
ตัวอย่างเช่น เราต้องการดึงค่ามาจาก collection user และเอามารวมกับข้อมูลที่ดึงมาจาก collection อื่น
ปกติก็ต้องไปใช้ lib อย่าง lodash หรือ underscore หรือไม่ก็เขียนเอง แต่ใน rxjs ก็มี <code>concat, merge</code> ให้เราสามารถใช้ได้เลย</p>
<h2><a class="anchor" aria-hidden="true" id="test"></a><a href="#test" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test</h2>
<p>ในส่วนของการ Test ในโปรเจคไม่ได้มีตัวอย่าง แต่เราสามารถ Test ได้
อย่างพวก Unit Test ก็เอา functional ที่เราแยกไว้แล้วมาเขียนได้เลย ส่วน Test แบบอื่นก็สามารถประยุกต์เอามาใช้ได้เหมือนกัน</p>
<h2><a class="anchor" aria-hidden="true" id="the-end"></a><a href="#the-end" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The End</h2>
<p>จบแล้วครับ หวังว่าจะเป็นประโยชน์ ถ้ามีอะไรผิดพลาดก็ขออภัยด้วยนะครับ</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#getting-started">Getting Started</a></li><li><a href="#how-it-work">How it work</a></li><li><a href="#rxjs">RxJs</a></li><li><a href="#test">Test</a></li><li><a href="#the-end">The End</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"></section><a href="https://code.facebook.com/projects/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/blog/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2019 Champ Patyatawee</section></footer></div></body></html>